<!-- html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Tabela ligowa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/table.css' %}">
{% endblock %}

{% block content %}
<h1>ðŸ“Š Tabela Ligowa</h1>

{# JeÅ›li nie wybrano ligi â€” pokaÅ¼ kafelki lig do wyboru #}
{% if not league %}
    <p style="color:#555;">Wybierz ligÄ™, aby zobaczyÄ‡ tabelÄ™ dla danego sezonu.</p>
    <div class="leagues-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:1rem; margin-top:1rem;">
        {% for l in leagues %}
            {% if l.tournament_template_id %}
                <a href="{% url 'core:league_table_by_league' l.tournament_template_id %}" class="league-card" style="display:block; padding:1rem; background:#fff; border:1px solid #e6e6e6; border-radius:6px; text-decoration:none; color:inherit; box-shadow:0 1px 2px rgba(0,0,0,0.03);">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <div style="width:44px; height:44px; background:#f0f0f0; border-radius:6px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#333; overflow:hidden;">
                            {% if l.logo %}
                                <img src="{{ l.logo }}" alt="{{ l.name }}" style="width:44px; height:44px; object-fit:cover;">
                            {% else %}
                                {{ l.name|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <div>
                            <div style="font-weight:600;">{{ l.name }}</div>
                            <div style="font-size:0.85rem; color:#666;">{{ l.country }}</div>
                        </div>
                    </div>
                </a>
            {% elif l.tournament_id %}
                <a href="{% url 'core:league_table_by_league' l.tournament_id %}" class="league-card" style="display:block; padding:1rem; background:#fff; border:1px solid #e6e6e6; border-radius:6px; text-decoration:none; color:inherit; box-shadow:0 1px 2px rgba(0,0,0,0.03);">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <div style="width:44px; height:44px; background:#f0f0f0; border-radius:6px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#333; overflow:hidden;">
                            {% if l.logo %}
                                <img src="{{ l.logo }}" alt="{{ l.name }}" style="width:44px; height:44px; object-fit:cover;">
                            {% else %}
                                {{ l.name|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <div>
                            <div style="font-weight:600;">{{ l.name }}</div>
                            <div style="font-size:0.85rem; color:#666;">{{ l.country }}</div>
                        </div>
                    </div>
                </a>
            {% else %}
                <a href="{% url 'core:league_table_by_league' l.pk %}" class="league-card" style="display:block; padding:1rem; background:#fff; border:1px solid #e6e6e6; border-radius:6px; text-decoration:none; color:inherit; box-shadow:0 1px 2px rgba(0,0,0,0.03);">
                    <div style="display:flex; align-items:center; gap:0.75rem;">
                        <div style="width:44px; height:44px; background:#f0f0f0; border-radius:6px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#333; overflow:hidden;">
                            {% if l.logo %}
                                <img src="{{ l.logo }}" alt="{{ l.name }}" style="width:44px; height:44px; object-fit:cover;">
                            {% else %}
                                {{ l.name|slice:":1"|upper }}
                            {% endif %}
                        </div>
                        <div>
                            <div style="font-weight:600;">{{ l.name }}</div>
                            <div style="font-size:0.85rem; color:#666;">{{ l.country }}</div>
                        </div>
                    </div>
                </a>
            {% endif %}
        {% endfor %}
    </div>

{% else %}

<div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem;">
    {% if league.logo %}
        <img src="{{ league.logo }}" alt="{{ league.name }}" style="width:64px; height:64px; object-fit:cover; border-radius:6px;">
    {% endif %}
    <div>
        <h2 style="margin:0;">{{ league.name }}</h2>
        <div style="color:#666;">{{ league.country }}</div>
    </div>
</div>

<form id="league-select-form" method="get" style="margin: 0 0 1rem 0; display:flex; align-items:center; gap:1rem;">
    {% if leagues %}
        <label for="league-select" style="font-weight:600;">Liga:</label>
        <select id="league-select" name="league_id" style="padding:0.35rem;">
            <option value="">-- wybierz ligÄ™ --</option>
            {% for l in leagues %}
                {% if l.tournament_template_id %}
                    {% with lid=l.tournament_template_id|stringformat:"s" %}
                        <option value="{{ lid }}" {% if selected_lid == lid %}selected{% endif %}>{{ l.name }}</option>
                    {% endwith %}
                {% elif l.tournament_id %}
                    {% with lid=l.tournament_id|stringformat:"s" %}
                        <option value="{{ lid }}" {% if selected_lid == lid %}selected{% endif %}>{{ l.name }}</option>
                    {% endwith %}
                {% else %}
                    {% with lid=l.pk|stringformat:"s" %}
                        <option value="{{ lid }}" {% if selected_lid == lid %}selected{% endif %}>{{ l.name }}</option>
                    {% endwith %}
                {% endif %}
            {% endfor %}
        </select>
    {% endif %}

    {% if seasons %}
        <label for="season-select" style="font-weight:600;">Sezon:</label>
        <select id="season-select" name="season_id" style="padding:0.35rem;">
            <option value="">-- wszystkie --</option>
            {% for s in seasons %}
                <option value="{{ s.season_id }}" {% if selected_season and s.season_id == selected_season.season_id %}selected{% endif %}>
                    {{ s.name|default:"Unknown" }} ({{ s.season_id }})
                </option>
            {% endfor %}
        </select>
    {% endif %}

    <noscript><button type="submit">PokaÅ¼</button></noscript>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Kafelki majÄ… normalne linki (bez przechwytywania) â€” klik dziaÅ‚a nawet bez JS.

        // Dropdown lig (gÃ³rny) â€” nadal przekierowuje lub aktualizuje
        var leagueSelect = document.getElementById('league-select');
        if (leagueSelect) {
            leagueSelect.addEventListener('change', function () {
                var leagueVal = leagueSelect.value;
                var seasonSelect = document.getElementById('season-select');
                var seasonVal = seasonSelect ? seasonSelect.value : '';
                if (!leagueVal) {
                    var url = '{% url "core:league_table" %}';
                    if (seasonVal) url += '?season_id=' + encodeURIComponent(seasonVal);
                    window.location.href = url;
                    return;
                }
                var urlStr = '{% url "core:league_table_by_league" "__LEAGUE__" %}'.replace('__LEAGUE__', encodeURIComponent(leagueVal));
                if (seasonVal) urlStr += '?season_id=' + encodeURIComponent(seasonVal);
                window.location.href = urlStr;
            });
        }

        // Selekcja sezonu â€” przeÅ‚aduj partial tabeli przez AJAX
        var seasonSelect = document.getElementById('season-select');
        if (seasonSelect) {
            seasonSelect.addEventListener('change', function () {
                var seasonVal = seasonSelect.value;
                // wyciÄ…gnij league z URL
                var pathParts = window.location.pathname.split('/');
                var leagueId = pathParts.length > 2 ? pathParts[2] : '';
                var url = '{% url "core:league_table_partial" "__LEAGUE__" %}'.replace('__LEAGUE__', encodeURIComponent(leagueId));
                if (seasonVal) url += '?season_id=' + encodeURIComponent(seasonVal);
                fetch(url).then(function (r) { return r.json(); }).then(function (d) { if (d.html) document.getElementById('table-root').innerHTML = d.html; });
            });
        }
    });
</script>

<div id="table-root">
    {% include 'core/_league_table_partial.html' %}
</div>

{% endif %}
{% endblock %}
